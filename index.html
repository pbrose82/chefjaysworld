<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Chefjaysworld | Blackstone Griddles &amp; Kitchen Stories</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer="" src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.10.3/cdn.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
<style>
    [x-cloak] { display: none !important; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .gradient-bg {
        background: linear-gradient(135deg, #ff6a00 0%, #ee0979 100%);
    }
    .card-hover {
        transition: all 0.3s ease;
    }
    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .fade-in {
        animation: fadeIn 0.6s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .tab-active {
        border-bottom: 3px solid #ff6a00;
        color: #ff6a00;
    }
    .logo-img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    /* */
    .toast {
        animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-in 3s forwards;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; transform: translateX(100%); }
    }
</style>
</head>
<body class="bg-gray-50">
<div id="app" x-data="appData()" x-init="init()">
<div class="fixed top-4 right-4 z-[100] w-full max-w-xs space-y-3">
    <template :key="toast.id" x-for="toast in toasts">
        <div @click="removeToast(toast.id)" class="toast relative w-full p-4 rounded-lg shadow-lg cursor-pointer" :class="{ 'bg-green-500 text-white': toast.type === 'success', 'bg-red-500 text-white': toast.type === 'error', 'bg-blue-500 text-white': toast.type === 'info' }">
            <p x-text="toast.message"></p>
        </div>
    </template>
</div>
<div class="fixed inset-0 bg-white z-50 flex items-center justify-center" x-cloak="" x-show="loading">
<div class="text-center">
<div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div>
<p class="mt-4 text-gray-600">Loading Chef Jay's World...</p>
</div>
</div>
<div class="fixed inset-0 z-50 overflow-y-auto" x-cloak="" x-show="showLoginModal">
<div class="flex items-center justify-center min-h-screen px-4">
<div @click="showLoginModal = false" class="fixed inset-0 bg-black opacity-50"></div>
<div class="relative bg-white rounded-lg max-w-md w-full p-6 shadow-xl">
<h2 class="text-2xl font-bold mb-4">Admin Login</h2>
<div class="bg-red-50 border border-red-200 text-red-600 p-3 rounded mb-4 text-sm" x-show="loginError">
<span x-text="loginError"></span>
</div>
<form @submit.prevent="login()">
<input class="w-full p-3 mb-4 border rounded-lg" placeholder="Email" required="" type="email" x-model="loginEmail"/>
<input class="w-full p-3 mb-4 border rounded-lg" placeholder="Password" required="" type="password" x-model="loginPassword"/>
<div class="flex justify-between">
<button class="bg-orange-500 text-white px-6 py-2 rounded-lg hover:bg-orange-600" type="submit">Login</button>
<button @click="showLoginModal = false; loginError = ''" class="text-gray-500 hover:text-gray-700" type="button">Cancel</button>
</div>
</form>
</div>
</div>
</div>

<section class="py-16 bg-orange-50" id="stories">
<div class="max-w-7xl mx-auto px-4">
<h2 class="text-3xl font-bold text-center mb-12">Share Your Kitchen Story</h2>
<div class="grid md:grid-cols-2 gap-8">
<div class="bg-white rounded-lg shadow-lg p-6">
    <h3 class="text-2xl font-bold mb-6">Latest Stories</h3>
    
    <div class="space-y-4 max-h-[600px] overflow-y-auto pr-4">
        <template :key="story.id" x-for="story in stories">
            <div class="border-b pb-4">
                <div class="flex items-start gap-4">
                    <img :src="story.imageUrl || 'https://placehold.co/100x100/eeeeee/cccccc?text=Story'" class="w-24 h-24 object-cover rounded-lg flex-shrink-0" alt="Story image" x-show="story.imageUrl">
                    <div class="flex-grow">
                        <h5 class="font-bold" x-text="story.name"></h5>
                        <p class="text-sm text-orange-600 mb-2" x-text="story.type"></p>
                        <p class="text-gray-600" x-text="story.story"></p>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <p class="text-xs text-gray-400" x-text="formatDate(story.timestamp)"></p>
                    <div class="flex items-center gap-3">
                        <button @click="voteOnStory(story, 'up')" class="text-gray-400 hover:text-green-500" :class="{ 'text-green-500 font-bold': hasVoted(story.id) }">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 01.707.293l5 5a1 1 0 01-1.414 1.414L11 5.414V16a1 1 0 11-2 0V5.414L5.707 8.707a1 1 0 01-1.414-1.414l5-5A1 1 0 0110 2z"></path></svg>
                        </button>
                        <span class="text-lg font-semibold text-gray-700" x-text="story.votes || 0"></span>
                    </div>
                </div>
            </div>
        </template>
        <p class="text-gray-500" x-show="stories.length === 0">No stories yet. Be the first to share!</p>
    </div>
</div>

<div class="bg-white rounded-lg shadow-lg p-6">
    <h3 class="text-2xl font-bold mb-6">Submit Your Story</h3>
    <form @submit.prevent="submitStory()">
        <input class="w-full p-3 mb-4 border rounded-lg" placeholder="Your Name" required="" type="text" x-model="storyForm.name"/>
        <input class="w-full p-3 mb-4 border rounded-lg" placeholder="Your Email" required="" type="email" x-model="storyForm.email"/>
        <select class="w-full p-3 mb-4 border rounded-lg" required="" x-model="storyForm.type">
            <option value="">Select Type</option>
            <option value="Burn of the Day">Burn of the Day</option>
            <option value="Food Concept">Food Concept</option>
            <option value="Kitchen Story">Kitchen Story</option>
            <option value="Question">Question for Chef Jay</option>
        </select>
        <textarea class="w-full p-3 mb-4 border rounded-lg" placeholder="Share your experience..." required="" rows="6" x-model="storyForm.story"></textarea>

        <label class="block text-sm font-medium text-gray-700 mb-2">Add an Image (Optional)</label>
        <div class="border rounded-lg p-3">
            <input @change="handleStoryImage" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100" type="file"/>
            <img x-show="storyForm.imageUrl" :src="storyForm.imageUrl" class="mt-4 rounded-lg w-32 h-32 object-cover" alt="Image preview">
        </div>

        <button :disabled="isSubmittingStory" class="w-full bg-orange-500 text-white py-3 mt-4 rounded-lg hover:bg-orange-600 transition font-bold disabled:opacity-50 flex items-center justify-center" type="submit">
            <svg x-show="isSubmittingStory" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span x-text="isSubmittingStory ? 'Submitting...' : 'Submit Story'"></span>
        </button>
    </form>
</div>
</div>
</div>
</section>

<footer class="bg-gray-800 text-white py-12">
<div class="max-w-7xl mx-auto px-4 text-center">
<p class="mb-2">Â© 2025 Chefjaysworld. All rights reserved.</p>
<p class="text-sm text-gray-400">All Blackstone links include automatic 10% discount for our community.</p>
</div>
</footer>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyACwcytRMry8xYii-Do4uErlli7CT6qMb0",
        authDomain: "chefjaysworld.firebaseapp.com",
        projectId: "chefjaysworld",
        storageBucket: "chefjaysworld.appspot.com",
        messagingSenderId: "156166389859",
        appId: "1:156166389859:web:c098e5804bef1c3601f856",
        measurementId: "G-BSEFPYMZD7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    
    console.log('ðŸ”¥ Firebase initialized.');

    function appData() {
        return {
            // UI States
            loading: true,
            showLoginModal: false,
            // ... (other states remain the same)
            isSubmittingStory: false, // MODIFICATION: New state for story submission
            
            // MODIFICATION: Toasts array for notifications
            toasts: [],
            
            // Data
            products: [],
            stories: [],
            pendingStories: [],
            votedStoryIds: [], // To track votes locally
            
            // Forms
            // ... (login and product forms remain the same)
            storyForm: { // MODIFICATION: Added image fields
                name: '',
                email: '',
                type: '',
                story: '',
                imageFile: null,
                imageUrl: ''
            },
            
            async init() {
                try {
                    console.log('ðŸ”„ Initializing app...');
                    this.loadVotedStories();
                    auth.onAuthStateChanged(async (user) => {
                        this.isAdmin = !!user;
                        this.currentUser = user;
                    });
                    
                    await this.loadProducts();
                    await this.loadStories();
                    await this.loadSettings();
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showToast('Could not load site data.', 'error');
                } finally {
                    this.loading = false;
                }
            },

            // MODIFICATION: Disabled automatic admin creation
            async login() {
                this.loginError = '';
                try {
                    const result = await auth.signInWithEmailAndPassword(this.loginEmail, this.loginPassword);
                    this.isAdmin = true;
                    this.currentUser = result.user;
                    this.showLoginModal = false;
                    this.showAdminPanel = true;
                    this.loginEmail = '';
                    this.loginPassword = '';
                    this.showToast('Logged in successfully!');
                } catch (error) {
                    console.error('Login error:', error);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        this.loginError = 'Invalid credentials. Please try again.';
                    } else {
                        this.loginError = 'An unexpected error occurred.';
                    }
                }
            },

            // MODIFICATION: Replaced all `alert()` with `showToast()`
            async addProduct() {
                // ... logic for adding a product
                try {
                    // ... (existing code)
                    // this.showToast('Product added successfully!');
                } catch (error) {
                    this.showToast('Failed to add product.', 'error');
                }
                // ... (existing code)
            },

            // MODIFICATION: Story submission with image upload
            async submitStory() {
                if (this.isSubmittingStory) return;
                this.isSubmittingStory = true;
                
                try {
                    let storyImageUrl = '';
                    // Upload image if one is selected
                    if (this.storyForm.imageFile) {
                        const file = this.storyForm.imageFile;
                        const filename = `stories/${Date.now()}_${file.name}`;
                        const storageRef = storage.ref(filename);
                        const snapshot = await storageRef.put(file);
                        storyImageUrl = await snapshot.ref.getDownloadURL();
                    }

                    const story = {
                        name: this.storyForm.name,
                        email: this.storyForm.email,
                        type: this.storyForm.type,
                        story: this.storyForm.story,
                        imageUrl: storyImageUrl,
                        status: 'pending',
                        featured: false,
                        votes: 0, // Initialize votes
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('stories').add(story);
                    
                    this.storyForm = { name: '', email: '', type: '', story: '', imageFile: null, imageUrl: '' };
                    this.showToast('Story submitted for review!', 'success');
                    
                } catch (error) {
                    console.error('Error submitting story:', error);
                    this.showToast('Failed to submit story.', 'error');
                } finally {
                    this.isSubmittingStory = false;
                }
            },
            
            // MODIFICATION: Handle story image selection and preview
            handleStoryImage(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        this.showToast('Image file is too large (max 5MB).', 'error');
                        return;
                    }
                    this.storyForm.imageFile = file;
                    this.storyForm.imageUrl = URL.createObjectURL(file);
                }
            },

            // MODIFICATION: New functions for voting
            loadVotedStories() {
                this.votedStoryIds = JSON.parse(localStorage.getItem('voted_stories')) || [];
            },
            hasVoted(storyId) {
                return this.votedStoryIds.includes(storyId);
            },
            async voteOnStory(story, voteType) {
                if (this.hasVoted(story.id)) {
                    this.showToast('You have already voted for this story.', 'info');
                    return;
                }

                try {
                    // Use a transaction to safely update the vote count
                    const storyRef = db.collection('stories').doc(story.id);
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(storyRef);
                        if (!doc.exists) {
                            throw "Document does not exist!";
                        }
                        const newVotes = (doc.data().votes || 0) + 1;
                        transaction.update(storyRef, { votes: newVotes });
                    });

                    // Update local data
                    const storyIndex = this.stories.findIndex(s => s.id === story.id);
                    if(storyIndex !== -1) {
                        this.stories[storyIndex].votes = (this.stories[storyIndex].votes || 0) + 1;
                    }

                    // Mark as voted in localStorage
                    this.votedStoryIds.push(story.id);
                    localStorage.setItem('voted_stories', JSON.stringify(this.votedStoryIds));
                    
                    this.showToast('Vote counted!', 'success');

                } catch (error) {
                    console.error("Error voting:", error);
                    this.showToast('Could not count your vote.', 'error');
                }
            },

            // MODIFICATION: New functions for Toast Notifications
            showToast(message, type = 'success') {
                const id = Date.now();
                this.toasts.push({ id, message, type });
                setTimeout(() => {
                    this.removeToast(id);
                }, 4000);
            },
            removeToast(id) {
                this.toasts = this.toasts.filter(toast => toast.id !== id);
            },

            // Make sure other functions also use showToast instead of alert
            async deleteProduct(productId) {
                 if (confirm('Are you sure you want to delete this product?')) {
                    try {
                        await db.collection('products').doc(productId).delete();
                        this.products = this.products.filter(p => p.id !== productId);
                        this.showToast('Product deleted.', 'success');
                    } catch (error) {
                        this.showToast('Failed to delete product.', 'error');
                    }
                }
            }
            // ... and so on for all other functions.
        }
    }
</script>
</body>
</html>
